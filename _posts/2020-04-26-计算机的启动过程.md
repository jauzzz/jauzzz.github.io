---
layout: post
title: "计算机的启动过程"
subtitle: "BIOS和主引导扇区"
modified: 2020-04-26 17:29:09 +0800
tags: []
image:
  feature: 
  credit: 
  creditlink: 
comments: 
share: 
disqus: 
mathjax: y

---



# 计算机的启动过程



> 计算机的启动，就是让计算机从空置状态，进入到工作状态：**CPU 不停地运行**



## CPU 的工作模式

CPU 是按照固定的模式运行的：

1. 取指 （CPU 是通过指令地址来获取指令）
2. 译码
3. 执行
4. 进入下一个循环（取指-译码-执行）



开机后，CPU 就会进入这个工作循环

但是取指阶段，是存在未知参数的，就是 `指令地址`

就是开机后面临的第一个问题：**第一条指令地址是什么**



## 指令地址与指令内容

**计算机中，所有的指令和数据都是二进制的，存储在存储器中**

不同类型的指令/数据，都会有对应的编码方式，存储成对应的二进制格式



计算机的存储器是由若干个存储单元组成的，这些存储单元按顺序编号

![未命名文件](https://tva1.sinaimg.cn/large/007S8ZIlgy1ge19bcfv2uj308g044a9w.jpg)

一个存储单元，通常可以存储一个字节，称为一个比特（Byte）

> 1 Byte = 8 bit = 8 个二进制位（一个二进制位，就是一个 0/1）



假设，我们要存储字符串 `abc123`:

1. 转换成二进制形式: `01100001 01100010 01100011 00110001 00110010 00110011`
2. 确认存储的起始地址 (假设为存储单元120)
3. 顺序存储 （该二进制串为 6 个比特）

假设，我们要读取刚才存储的字符串 `abc123`:

1. 找到它存储的起始位置 (存储单元120)
2. 确认要读取的长度 （6 个比特）
3. 顺序读取



## CPU 与存储器的交互模型

从宏观上的角度来看，一个读写行为需要的信息为：

- 存储单元的地址（地址信息）
- 读或写的命令（控制信息）
- 读或写的数据（数据信息）

<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge19bd9lx8j30pw0i275j.jpg" alt="image-20200421115116314" style="zoom:50%;" />



假设 CPU 从 3 号单元中读取数据：

1. CPU 通过地址线发送地址信息 3
2. CPU 通过控制线，发出内存读取命令，选中存储器芯片并通知它进行读取
3. 存储器将 3 号单元的信息 08 通过数据线送回 CPU

假设 CPU 从 3 号单元中写入数据 `x`：

1. CPU 通过地址线发送地址信息 3
2. CPU 通过控制线，发出内存写入命令，选中存储器芯片并通知它进行读取
3. 存储器通过数据线，将数据 `x` 送入内存的 3 号单元



## 第一条指令

回归正题，开机后第一条指令的地址是什么？

需要从存储器本身说起



计算机的存储器分为两种：

- RAM ：`易失性存储器`，当电流断电后，所存储的数据便会消失
- ROM：`非易失性存储器`，电流断电不会影响所存储的数据

这意味着，当开机的时候，RAM 是没有数据的，所以只能从 ROM 获取第一条开机的指令



因此，计算机的设计者，专门划分了内存地址范围，用于存储开机的指令，称为 `BIOS ROM`

同时，规定了开机的步骤：

1. 开机时，CS:IP 指向 `0xFFFF0`，这就是开机的*第一条指令*
2. 指令默认加载顺序是从 *低地址->高地址*，所以接下来的默认顺序是 0xFFFF0 ~ 0xFFFFF
   一共有 16 字节的长度，肯定是无法完成开机的工作的，所以应该是跳转到低地址去执行
3. BIOS ROM 的主要工作是：**硬件的检测、诊断和初始化，并提供与外围设备交互的例程**
4. 当 BIOS ROM 完成了主要工作后，会将控制权转移给辅助存储设备的*主引导扇区*



<img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge1c445b40j30p80piq62.jpg" alt="image-20200220161213812" style="zoom: 50%;" />



## 主引导扇区

通常来说，主引导扇区指的是硬盘的 `0面0道1扇区 （1个扇区大小为 512 字节）` 

它是由操作系统提供的，负责为计算机加载操作系统：

- 检测用来启动计算机的操作系统，并计算它的硬盘位置
- 将操作系统的自举代码加载到内存，跳转执行，直到操作系统完全启动



主引导扇区在最后有一个有效标志（有效的主引导扇区，最后两个字节是 `0x55` 和 `0xAA`）

计算机会将主引导扇区的代码加载到物理内存地址 `0x7c00` ，加载完成后，如果该扇区是有效的就会执行



至此，启动过程完成



## Reference

- [BIOS](https://en.wikipedia.org/wiki/BIOS)
- [计算机是如何启动的](http://www.ruanyifeng.com/blog/2013/02/booting.html)

